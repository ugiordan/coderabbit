# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json

# Plugin Version: 2.4.0
# DO NOT REMOVE: This comment is used for version detection during plugin updates
# CodeRabbit Configuration - Automated Security Scanning
# Generated by security-findings-manager plugin
# This enables PR-level security scanning with the same tools used in full scans

language: "en-US"
early_access: false

tone_instructions: "Prioritize security (secrets, RBAC, CVEs) with CVE/CWE IDs and remediation. Also flag code quality issues, bugs, and best practices. Be constructive and specific."

reviews:
  profile: chill  # Focused feedback - less overwhelming, builds trust first

  request_changes_workflow: false  # Non-blocking for development velocity

  high_level_summary: true
  review_status: true
  collapse_walkthrough: true
  sequence_diagrams: false
  changed_files_summary: false
  suggested_labels: false
  suggested_reviewers: false
  related_issues: false
  related_prs: false
  poem: false

  finishing_touches:
    docstrings:
      enabled: false
    unit_tests:
      enabled: false

  commit_status: true
  fail_commit_status: false  # Don't block PRs during evaluation

  # ============================================================================
  # COMPREHENSIVE SECURITY TOOL SUITE (16 Tools)
  # ============================================================================
  # Architecture: PR incremental scanning on CHANGED files only
  # Complement: GitHub Actions workflow scans ENTIRE codebase weekly
  # Philosophy: Fast feedback loop (seconds) vs comprehensive baseline (minutes)
  # Auto-detection: Language-specific tools auto-skip repos without applicable files
  #
  # Tool Categories:
  # - Secrets: gitleaks (patterns), truffleHog (verified)
  # - SAST: semgrep, opengrep
  # - IaC: checkov, trivy
  # - Dependencies: osvScanner
  # - Languages: eslint (TS/JS), ruff (Python), cppcheck (C/C++), sqlfluff (SQL)
  # - Infrastructure: shellcheck (shell), hadolint (Docker), yamllint (YAML), actionlint (GHA)
  # - Documentation: markdownlint

  tools:
    # ------------------------------------------------------------------------
    # SECRETS DETECTION - Gitleaks (Pattern-based)
    # ------------------------------------------------------------------------
    # What: Detects hardcoded secrets using ~100 regex patterns
    # When: Every PR, only on changed files
    # Speed: Fast (pattern matching)
    gitleaks:
      enabled: true

    # ------------------------------------------------------------------------
    # SECRETS DETECTION - TruffleHog (Verified Detection) (NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: Detects AND verifies live credentials by testing against APIs
    # Coverage: 800+ credential types with verification
    # Benefit: "Verified: true" means ACTIVE credential - 70% fewer false positives
    # Complements: Gitleaks does pattern matching, TruffleHog confirms if secrets are live
    # Priority: CRITICAL - rotate immediately if "Verified: true"
    truffleHog:
      enabled: true

    # ------------------------------------------------------------------------
    # CUSTOM SECURITY RULES - Semgrep
    # ------------------------------------------------------------------------
    # What: Custom SAST rules for your codebase
    # Config: Repository-specific semgrep rules (installed by plugin)
    # Note: config_file resolves relative to each scanned repo, not the central coderabbit repo.
    # Each RHOAI repo must have .github/config/semgrep.yaml deployed locally.
    semgrep:
      enabled: true
      config_file: ".github/config/semgrep.yaml"

    # ------------------------------------------------------------------------
    # HIGH-PERFORMANCE SAST - OpenGrep (NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: High-performance alternative SAST engine
    # Coverage: Fast security pattern matching across multiple languages
    # Benefit: Complements Semgrep with different rule coverage
    # Auto-skip: Only runs on supported languages
    opengrep:
      enabled: true

    # ------------------------------------------------------------------------
    # IaC SECURITY - Checkov
    # ------------------------------------------------------------------------
    # What: Scans Kubernetes manifests, Dockerfiles, Terraform for misconfigurations
    # Detects: Missing SecurityContext, privileged containers, public S3 buckets
    # Policies: ~1000 built-in checks for AWS, Azure, GCP, Kubernetes
    checkov:
      enabled: true

    # ------------------------------------------------------------------------
    # DEPENDENCY SCANNING - OSV Scanner (CRITICAL - NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: Detects known CVEs in dependencies (go.mod, package.json, requirements.txt)
    # Database: OSV (Open Source Vulnerabilities) - Google-maintained
    # Coverage: Go modules, npm, PyPI, Maven, NuGet
    # Benefit: Early warning on vulnerable dependencies in PRs
    # WHY CRITICAL: Prevents supply chain attacks (Log4Shell, OpenSSL CVEs)
    osvScanner:
      enabled: true

    # ------------------------------------------------------------------------
    # CONTAINER & HELM SECURITY - Trivy (NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: Scans container images, Helm charts, and IaC for vulnerabilities
    # Detects: CVEs in base images, misconfigurations in Helm values
    # Coverage: Dockerfiles, Helm charts, K8s manifests
    # Benefit: Complements Checkov - Checkov checks structure, Trivy checks contents
    # Auto-skip: Only runs if Dockerfiles or Helm charts exist in PR
    trivy:
      enabled: true

    # ------------------------------------------------------------------------
    # TYPESCRIPT/JAVASCRIPT LINTING - ESLint (NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: Static analysis for TypeScript/JavaScript code
    # Detects: XSS (dangerouslySetInnerHTML), missing await, React hooks issues
    # Coverage: .ts, .tsx, .js, .jsx files
    # Benefit: odh-dashboard has 3,000+ TypeScript files with no automated TS linting
    # Auto-skip: Only runs if TypeScript/JavaScript files exist in PR
    eslint:
      enabled: true

    # ------------------------------------------------------------------------
    # PYTHON SECURITY & QUALITY - Ruff (NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: Fast Python linter with security rules (Flake8 + Bandit + more)
    # Detects: S105 (hardcoded passwords), S608 (SQL injection), S301 (unsafe pickle)
    # Coverage: All .py files
    # Benefit: 17 Python repos with no automated Python security linting
    # Auto-skip: Only runs if Python files exist in PR
    ruff:
      enabled: true

    # ------------------------------------------------------------------------
    # C/C++ STATIC ANALYSIS - Cppcheck (NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: Static analysis for C/C++ code
    # Detects: Memory leaks, buffer overflows, null pointer dereferences
    # Coverage: .c, .cpp, .cc, .cxx, .h, .hpp files
    # Benefit: modelmesh and ml-metadata contain C++ code
    # Auto-skip: Only runs if C/C++ files exist in PR
    cppcheck:
      enabled: true

    # ------------------------------------------------------------------------
    # SQL LINTING - SQLFluff (NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: SQL linter and formatter
    # Detects: SQL anti-patterns, formatting issues, potential injection risks
    # Coverage: .sql files and SQL in Python/Go code
    # Benefit: Data pipeline repos likely contain SQL queries
    # Auto-skip: Only runs if SQL files exist in PR
    sqlfluff:
      enabled: true

    # ------------------------------------------------------------------------
    # GOLANG LINTING - Disabled by default (usually runs in CI)
    # ------------------------------------------------------------------------
    # Why disabled: golangci-lint with gosec usually runs in existing CI pipeline
    # To enable: Uncomment below if you don't have Go security scanning in CI
    # golangci-lint:
    #   enabled: true

    # ------------------------------------------------------------------------
    # SHELL SCRIPT SECURITY - ShellCheck
    # ------------------------------------------------------------------------
    # What: Static analysis for bash/sh scripts
    # Detects: Unquoted variables, command injection, SC2086, SC2046
    # OWASP: Prevents CWE-78 (OS Command Injection)
    shellcheck:
      enabled: true

    # ------------------------------------------------------------------------
    # DOCKERFILE SECURITY - Hadolint
    # ------------------------------------------------------------------------
    # What: Dockerfile linter enforcing best practices
    # Detects: Secrets in ENV, unpinned base images, running as root
    # Standards: Docker best practices + CIS Benchmark
    hadolint:
      enabled: true

    # ------------------------------------------------------------------------
    # YAML VALIDATION - yamllint
    # ------------------------------------------------------------------------
    # What: Validates YAML syntax and style for Kubernetes manifests
    # Detects: Syntax errors, inconsistent indentation, truthy issues
    # Benefit: Catches deployment-breaking YAML errors early
    yamllint:
      enabled: true

    # ------------------------------------------------------------------------
    # GITHUB ACTIONS VALIDATION - actionlint (NEW in v2.4.0)
    # ------------------------------------------------------------------------
    # What: Validates GitHub Actions workflow syntax and security
    # Detects: Invalid expressions, undefined secrets, unsafe patterns
    # Coverage: .github/workflows/*.yml files
    # Benefit: Faster PR feedback (complements CI actionlint)
    # Auto-skip: Only runs if workflow files exist in PR
    actionlint:
      enabled: true

    # ------------------------------------------------------------------------
    # MARKDOWN LINTING - markdownlint
    # ------------------------------------------------------------------------
    # What: Validates Markdown documentation quality
    # Detects: Broken links, inconsistent formatting, accessibility issues
    # Benefit: Improves documentation readability and maintainability
    markdownlint:
      enabled: true

  # ============================================================================
  # PATH-SPECIFIC SECURITY INSTRUCTIONS
  # ============================================================================

  path_instructions:
    # --------------------------------------------------------------------------
    # KUBERNETES MANIFESTS - General Security
    # --------------------------------------------------------------------------
    - path: "**/*.yaml"
      instructions: |
        KUBERNETES SECURITY CHECKS:
        1. No privileged containers or hostPath mounts
        2. Resource limits defined (memory, CPU) - prevents DoS
        3. No wildcard RBAC permissions (resources: ["*"], verbs: ["*"])
        4. SecurityContext configured (runAsNonRoot, readOnlyRootFilesystem)
        5. No secrets in plain text (use SealedSecrets or external-secrets)
        6. NetworkPolicies for multi-tenancy isolation
        7. No hostNetwork, hostPID, hostIPC

    # --------------------------------------------------------------------------
    # RBAC MANIFESTS - Privilege Escalation Prevention (CWE-269)
    # --------------------------------------------------------------------------
    - path: "**/rbac/**/*.yaml"
      instructions: |
        RBAC SECURITY (Critical - Automated tools validate these):
        1. NO wildcards in resources: ["*"] - enables privilege escalation
        2. NO wildcards in verbs: ["*"] - enables privilege escalation
        3. NO cluster-admin bindings - use least-privilege custom roles
        4. NO dangerous verbs (escalate, impersonate, bind)
        5. Verify minimum required permissions only
        6. Prefer Role over ClusterRole (namespace scoping)
        7. Dedicated ServiceAccounts per workload

    # --------------------------------------------------------------------------
    # GO CODE - Kubernetes Operators & Controllers
    # --------------------------------------------------------------------------
    - path: "**/*.go"
      instructions: |
        GO SECURITY (Kubernetes Controllers):

        EXTERNAL API INTEGRATION:
        1. Use io.LimitReader for HTTP response bodies (prevent memory exhaustion)
           Example: io.ReadAll(io.LimitReader(resp.Body, 10*1024*1024))
        2. Validate all data from json.Unmarshal before storing in ConfigMaps/Secrets
           - Check length limits (prevent resource exhaustion)
           - Validate character patterns (no shell metacharacters: $, `, |, ;, &)
           - Enforce format constraints (regex validation)
        3. No InsecureSkipVerify in TLS configs (enables MITM attacks)

        KUBERNETES RESOURCE MANIPULATION:
        4. Validate CR spec fields before using in ConfigMaps/Secrets
           - No direct CR.Spec.Field → ConfigMap.Data without validation
        5. Set OwnerReferences on all child resources (prevents orphaned resources)
           - Use controllerutil.SetControllerReference(parent, child, scheme)

        COMMAND EXECUTION:
        6. Validate inputs before exec.Command (prevent command injection)
           - Use allowlist regex patterns for paths/arguments
           - Check for shell metacharacters (;|&$`<>(){}[])
           - Never use exec.Command("/bin/sh", "-c", userInput)

        SECRETS MANAGEMENT:
        7. Never log sensitive fields (Password, Token, APIKey, Secret.Data)
        8. Avoid weak cryptography (MD5, SHA1) for security operations

        DATA FLOW ANALYSIS:
        - Trace user-controlled data from CR spec → ConfigMap → Pod
        - Ensure validation at trust boundaries (webhook, reconciler)

    # --------------------------------------------------------------------------
    # PYTHON CODE - Services & ML Applications
    # --------------------------------------------------------------------------
    - path: "**/*.py"
      instructions: |
        PYTHON SECURITY:
        1. No eval() or exec() with untrusted input (CWE-94)
        2. Use parameterized queries for databases (prevent SQL injection)
        3. Validate file paths (prevent path traversal: ../../../etc/passwd)
        4. No shell=True in subprocess (use shell=False with list args)
        5. Proper input sanitization for all user inputs
        6. API authentication/authorization (JWT validation)
        7. Validate ML model file formats (prevent pickle exploits)
        8. Rate limiting for API endpoints (prevent DoS)

    # --------------------------------------------------------------------------
    # TYPESCRIPT/JAVASCRIPT - Dashboards & Web Services
    # --------------------------------------------------------------------------
    - path: "**/*.{ts,tsx,js,jsx}"
      instructions: |
        WEB SECURITY (XSS, CSRF Prevention):
        1. No dangerouslySetInnerHTML without sanitization (XSS - CWE-79)
        2. Validate all API responses before rendering (prevent XSS)
        3. CSRF token validation for state-changing operations
        4. Secure cookie settings (httpOnly, secure, sameSite)
        5. Content Security Policy (CSP) headers
        6. No sensitive data in localStorage (use secure httpOnly cookies)
        7. Input validation for all forms (prevent XSS in user-generated content)
        8. Sanitize Markdown/HTML in user content (prevent stored XSS)

    # --------------------------------------------------------------------------
    # DOCKERFILES - Container Image Security
    # --------------------------------------------------------------------------
    - path: "**/Dockerfile*"
      instructions: |
        DOCKERFILE SECURITY (CWE-798, CWE-250):
        1. No secrets in build args or ENV (CWE-798)
        2. Use specific image tags (not :latest) - ensures reproducibility
        3. Run as non-root user (USER 1000 or named user)
        4. Minimize layers and installed packages (reduce attack surface)
        5. Use multi-stage builds (no build tools in runtime image)
        6. Scan base images for CVEs (use minimal bases: distroless, alpine)
        7. No curl/wget in final stage (prevent runtime downloads)

    # --------------------------------------------------------------------------
    # SHELL SCRIPTS - Command Injection Prevention
    # --------------------------------------------------------------------------
    - path: "**/*.sh"
      instructions: |
        SHELL SCRIPT SECURITY (CWE-78):
        1. No hardcoded credentials (use environment variables)
        2. Quote all variables to prevent injection ("$VAR" not $VAR)
        3. Use 'set -euo pipefail' at script start (fail fast on errors)
        4. Input validation (regex patterns, length checks)
        5. Avoid eval and dynamic command execution (CWE-94)
        6. Use absolute paths for commands (/usr/bin/rm not rm)
        7. Sanitize filenames (check for path traversal: ../)

  # ============================================================================
  # PATH FILTERS (Exclude Non-Security-Critical Files)
  # ============================================================================

  path_filters:
    - "!.git/**"
    - "!vendor/**"
    - "!node_modules/**"
    - "!bin/**"
    - "!**/__pycache__/**"
    - "!**/*.pyc"
    - "!**/*.sum"
    - "!**/*.pb.go"
    - "!**/*.generated.go"

  # ============================================================================
  # AUTO REVIEW SETTINGS
  # ============================================================================

  auto_review:
    enabled: true
    drafts: false
    ignore_title_keywords:
      - "WIP"
      - "DO NOT MERGE"
    base_branches:
      - main
      - master
      - incubation

# ============================================================================
# KNOWLEDGE BASE
# ============================================================================

knowledge_base:
  learnings:
    scope: local
  issues:
    scope: local
